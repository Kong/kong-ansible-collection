---
- debug:
    var: "ansible_facts"

- name: "Test setup | Prepare CentOS 8 appstream repos"
  when:
    - "ansible_distribution == 'CentOS'"
    - "ansible_distribution_major_version == '8'"
  block:
    - name: "CentOS 8 | Enable baseurl"
      ansible.builtin.replace:
        path: "/etc/yum.repos.d/{{ item }}.repo"
        regexp: "#"
        replace: ""
      with_items:
        - "CentOS-Linux-AppStream"
        - "CentOS-Linux-BaseOS"
        - "CentOS-Linux-ContinuousRelease"
        - "CentOS-Linux-Debuginfo"
        - "CentOS-Linux-Devel"
        - "CentOS-Linux-Extras"
        - "CentOS-Linux-FastTrack"
        - "CentOS-Linux-HighAvailability"
        - "CentOS-Linux-Media"
        - "CentOS-Linux-Plus"
        - "CentOS-Linux-PowerTools"
        - "CentOS-Linux-Sources"
      become: True

- name: "Test setup | Ensure collections are available"
  command: "ansible-galaxy collection install community.general"
  delegate_to: "localhost"

- name: "Test setup | Ensure kubeconfig is on remote target"
  become: True
  block:
    - name: "Test setup | Edit kubeconfig for test container to access kubernetes running on host"
      ansible.builtin.replace:
        path: "{{ local_kubeconfig }}"
        regexp: "127.0.0.1"
        replace: "{{ k8s_instance }}"
      delegate_to: "localhost"

    - name: "Test setup | Create kubeconfig directory on target"
      ansible.builtin.file:
        state: "directory"
        path: "/root/.kube"
        mode: "0755"
        owner: "root"
        group: "root"

    - name: "Test setup | Copy kubeconfig to target"
      ansible.builtin.copy:
        src: "{{ local_kubeconfig }}"
        dest: "/root/.kube/config"
        mode: "0600"
        owner: "root"
        group: "root"

- name: "Test setup | include common test variables"
  ansible.builtin.include_vars: "common.yml"

- name: "Test setup (remote) | Copy files to remote"
  when: "values_location == 'remote_values'"
  block:
    - name: "Test setup (remote) | Create temp directory"
      ansible.builtin.tempfile:
        state: "directory"
        prefix: "k4k8s_deploy_setup"
      register: "__k4k8s_deploy_setup_dir__"
    
    - name: "Test setup (remote) | Copy files to remote"
      ansible.builtin.copy:
        src: "{{ item }}"
        dest: "{{ __k4k8s_deploy_setup_dir__['path'] }}/{{ item | basename }}"
      with_items:
        - "{{ k4k8s_deploy_helm_chart_values_files }}"
        - "{{ k4k8s_deploy_yaml_manifest_paths }}"
    
- name: "Test setup | include {{ values_location }} variables"
  ansible.builtin.include_vars: "{{ values_location }}.yml"

- name: "Test | k4k8s-deploy role"
  include_role:
    name: "k4k8s_deploy"
    public: True # so we can validate using the same role variables later

- name: "Validate deployment"
  ansible.builtin.include_tasks: "validate_deployment.yml"