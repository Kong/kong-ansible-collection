---
# set as a fact so validation can be performed with assesrts later if desired, rather than use a task variable
- name: "Ensure kong enterprise admin gui sessions configuration is set"
  ansible.builtin.set_fact:
    __k4k8s_deploy_admin_gui_session_conf_string__: "{\"cookie_name\": \"{{ k4k8s_deploy_admin_gui_sessions_settings['cookie_name'] | string }}\", \"secret\": \"{{ k4k8s_deploy_admin_gui_sessions_settings['secret'] | string }}\"{% if 'cookie_lifetime' in k4k8s_deploy_admin_gui_sessions_settings %}, \"cookie_lifetime\": {{ k4k8s_deploy_admin_gui_sessions_settings['cookie_lifetime'] | int }}{% endif %}{% if 'cookie_renew' in k4k8s_deploy_admin_gui_sessions_settings %}, \"cookie_renew\": {{ k4k8s_deploy_admin_gui_sessions_settings['cookie_renew'] | int }}{% endif %}{% if 'cookie_samesite' in k4k8s_deploy_admin_gui_sessions_settings %}, \"cookie_samesite\": \"{{ k4k8s_deploy_admin_gui_sessions_settings['cookie_samesite'] | string }}\"{% endif %}{% if 'cookie_secure' in k4k8s_deploy_admin_gui_sessions_settings %}, \"cookie_secure\": {{ k4k8s_deploy_admin_gui_sessions_settings['cookie_secure'] | default(false) | bool | lower }}{% endif %}{% if 'storage' in k4k8s_deploy_admin_gui_sessions_settings %}, \"storage\": \"{{ k4k8s_deploy_admin_gui_sessions_settings['storage'] | string }}\"{% endif %}{% if 'cookie_domain' in k4k8s_deploy_admin_gui_sessions_settings %}, \"cookie_domain\": \"{{ k4k8s_deploy_admin_gui_sessions_settings['cookie_domain'] }}\"{% endif %}}"
  when: "k4k8s_deploy_create_admin_gui_sessions_conf_secret | default(False) | bool"

# set as a fact so validation can be performed with assesrts later if desired, rather than use a task variable
- name: "Ensure kong enterprise developer portal sessions configuration dictionary is set"
  ansible.builtin.set_fact:
    __k4k8s_deploy_portal_session_conf_string__: "{\"cookie_name\": \"{{ k4k8s_deploy_portal_sessions_settings['cookie_name'] | string }}\", \"secret\": \"{{ k4k8s_deploy_portal_sessions_settings['secret'] | string }}\"{% if 'cookie_lifetime' in k4k8s_deploy_portal_sessions_settings %}, \"cookie_lifetime\": {{ k4k8s_deploy_portal_sessions_settings['cookie_lifetime'] | int }}{% endif %}{% if 'cookie_renew' in k4k8s_deploy_portal_sessions_settings %}, \"cookie_renew\": {{ k4k8s_deploy_portal_sessions_settings['cookie_renew'] | int }}{% endif %}{% if 'cookie_samesite' in k4k8s_deploy_portal_sessions_settings %}, \"cookie_samesite\": \"{{ k4k8s_deploy_portal_sessions_settings['cookie_samesite'] | string }}\"{% endif %}{% if 'cookie_secure' in k4k8s_deploy_portal_sessions_settings %}, \"cookie_secure\": {{ k4k8s_deploy_portal_sessions_settings['cookie_secure'] | default(false) | bool | lower }}{% endif %}{% if 'storage' in k4k8s_deploy_portal_sessions_settings %}, \"storage\": \"{{ k4k8s_deploy_portal_sessions_settings['storage'] | string }}\"{% endif %}{% if 'cookie_domain' in k4k8s_deploy_portal_sessions_settings %}, \"cookie_domain\": \"{{ k4k8s_deploy_portal_sessions_settings['cookie_domain'] }}\"{% endif %}}"
  when: "k4k8s_deploy_create_portal_sessions_conf_secret | default(False) | bool"

- name: "Ensure kong enterprise sessions configuration secret is present"
  kubernetes.core.k8s:
    state: "present"
    definition: "{{ lookup('template', 'templates/secret-kong-session-conf.yaml.j2' | from_yaml) }}"